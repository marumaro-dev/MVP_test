<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8" />
        <title>5core ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆç®¡ç†è€…ç”¨ï¼‰</title>
    </head>
    <body>
        <h1>5core ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆç®¡ç†è€…ç”¨ï¼‰</h1>

        <p id="status">æœªãƒ­ã‚°ã‚¤ãƒ³</p>

        <button id="login-btn">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
        <button id="export-btn" disabled>CSV ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>

        <!-- â–¼ ã“ã“ã‹ã‚‰ä¸‹ãŒ JS èª­ã¿è¾¼ã¿ï¼†æœ¬ä½“ã‚³ãƒ¼ãƒ‰ â–¼ -->

        <!-- Firebase SDKï¼ˆcompatç‰ˆï¼‰ -->
        <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-auth-compat.js"></script>

        <!-- ã‚ãªãŸã® Firebase è¨­å®šï¼ˆfirebase.initializeApp, const db = firebase.firestore() ã‚’å®šç¾©ã—ã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ -->
        <script src="config.js"></script>

        <!-- ğŸ‘‡ ã“ã“ã«ã€Œauth + exportã€ã®ã‚³ãƒ¼ãƒ‰ã‚’ã¾ã¨ã‚ã¦æ›¸ã -->
        <script>
            // Firebase Auth ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
            const auth = firebase.auth();
            const provider = new firebase.auth.GoogleAuthProvider();

            const statusEl = document.getElementById("status");
            const loginBtn = document.getElementById("login-btn");
            const exportBtn = document.getElementById("export-btn");

            // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ç›£è¦–
            auth.onAuthStateChanged((user) => {
                if (user) {
                    statusEl.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š${user.email}`;
                    exportBtn.disabled = false; // ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½ã«
                } else {
                    statusEl.textContent = "æœªãƒ­ã‚°ã‚¤ãƒ³";
                    exportBtn.disabled = true;
                }
            });

            // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ â†’ Googleãƒ­ã‚°ã‚¤ãƒ³
            loginBtn.addEventListener("click", async () => {
                try {
                    await auth.signInWithPopup(provider);
                    // onAuthStateChanged ãŒå‘¼ã°ã‚Œã¦ãƒœã‚¿ãƒ³ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã‚‹
                } catch (e) {
                    console.error(e);
                    alert("ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ");
                }
            });

            // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå‡¦ç†
            exportBtn.addEventListener("click", async () => {
                exportBtn.disabled = true;
                exportBtn.textContent = "ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆä¸­...";

                try {
                    const snapshot = await db
                        .collection("diagnosisAnswers")
                        .orderBy("createdAt")
                        .get();

                    const rows = [];

                    // ãƒ˜ãƒƒãƒ€è¡Œ
                    rows.push([
                        "id",
                        "createdAt",
                        "nickname",
                        "mbtiType",
                        "raw_E",
                        "raw_O",
                        "raw_C",
                        "raw_A",
                        "raw_N",
                        "big5_E",
                        "big5_O",
                        "big5_C",
                        "big5_A",
                        "big5_N",
                        "z_E",
                        "z_O",
                        "z_C",
                        "z_A",
                        "z_N",
                        "type5",
                        ...Array.from({ length: 50 }, (_, i) => `q${i + 1}`),
                    ]);

                    snapshot.forEach((doc) => {
                        const d = doc.data();
                        const raw = d.raw || {};
                        const big5 = d.big5 || {};
                        const z = d.z || {};
                        const answers = d.answers || {};

                        const row = [
                            doc.id,
                            d.createdAt
                                ? d.createdAt.toDate().toISOString()
                                : "",
                            d.nickname ?? "",
                            d.mbtiType ?? "",
                            raw.E ?? "",
                            raw.O ?? "",
                            raw.C ?? "",
                            raw.A ?? "",
                            raw.N ?? "",
                            big5.E ?? "",
                            big5.O ?? "",
                            big5.C ?? "",
                            big5.A ?? "",
                            big5.N ?? "",
                            z.E ?? "",
                            z.O ?? "",
                            z.C ?? "",
                            z.A ?? "",
                            z.N ?? "",
                            d.type5 ?? "",
                            ...Array.from(
                                { length: 50 },
                                (_, i) => answers[i + 1] ?? ""
                            ),
                        ];

                        rows.push(row);
                    });

                    // CSV æ–‡å­—åˆ—ã«å¤‰æ›
                    const csv = rows
                        .map((cols) =>
                            cols
                                .map((c) => {
                                    const s = String(c ?? "");
                                    if (/[",\n]/.test(s)) {
                                        return `"${s.replace(/"/g, '""')}"`;
                                    }
                                    return s;
                                })
                                .join(",")
                        )
                        .join("\n");

                    const blob = new Blob([csv], {
                        type: "text/csv;charset=utf-8;",
                    });
                    const url = URL.createObjectURL(blob);

                    const a = document.createElement("a");
                    a.href = url;
                    a.download = "5core_answers.csv";
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    exportBtn.textContent = "CSV ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰";
                    exportBtn.disabled = false;
                } catch (e) {
                    console.error(e);
                    alert("ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
                    exportBtn.textContent = "CSV ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰";
                    exportBtn.disabled = false;
                }
            });
        </script>
    </body>
</html>
